function brainsprite(d){function a(f,e){f.imageSmoothingEnabled=e;return f}var b={};var c={nanValue:false,smooth:false,flagValue:false,colorBackground:"#000000",flagCoordinates:false,origin:{X:0,Y:0,Z:0},voxelSize:1,affine:false,heightColorBar:0.04,sizeFont:0.075,colorFont:"#FFFFFF",nbDecimals:3,crosshair:false,colorCrosshair:"#0000FF",sizeCrosshair:0.9,title:false,numSlice:false,};var b=Object.assign({},c,d);if(typeof b.affine==="boolean"&&b.affine===false){b.affine=[[b.voxelSize,0,0,-b.origin.X],[0,b.voxelSize,0,-b.origin.Y],[0,0,b.voxelSize,-b.origin.Z],[0,0,0,1]]}b.canvas=document.getElementById(d.canvas);b.context=b.canvas.getContext("2d");b.context=a(b.context,b.smooth);b.canvasY=document.createElement("canvas");b.contextY=b.canvasY.getContext("2d");b.canvasZ=document.createElement("canvas");b.contextZ=b.canvasZ.getContext("2d");b.canvasRead=document.createElement("canvas");b.contextRead=b.canvasRead.getContext("2d");b.canvasRead.width=1;b.canvasRead.height=1;b.onclick=typeof d.onclick!=="undefined"?d.onclick:"";if(b.flagCoordinates){b.spaceFont=0.1}else{b.spaceFont=0}b.sprite=document.getElementById(d.sprite);b.nbCol=b.sprite.width/d.nbSlice.Y;b.nbRow=b.sprite.height/d.nbSlice.Z;b.nbSlice={X:typeof d.nbSlice.X!=="undefined"?d.nbSlice.X:b.nbCol*b.nbRow,Y:d.nbSlice.Y,Z:d.nbSlice.Z};b.widthCanvas={X:0,Y:0,Z:0};b.heightCanvas={X:0,Y:0,Z:0,max:0};if(b.numSlice==false){b.numSlice={X:Math.floor(b.nbSlice.X/2),Y:Math.floor(b.nbSlice.Y/2),Z:Math.floor(b.nbSlice.Z/2)}}b.numSlice.Z=b.nbSlice.Z-b.numSlice.Z;b.coordinatesSlice={X:0,Y:0,Z:0};b.planes={};b.planes.canvasMaster=document.createElement("canvas");b.planes.contextMaster=b.planes.canvasMaster.getContext("2d");d.overlay=typeof d.overlay!=="undefined"?d.overlay:false;if(d.overlay){b.overlay={};b.overlay.sprite=document.getElementById(d.overlay.sprite);b.overlay.nbCol=b.overlay.sprite.width/d.overlay.nbSlice.Y;b.overlay.nbRow=b.overlay.sprite.height/d.overlay.nbSlice.Z;b.overlay.nbSlice={X:typeof d.overlay.nbSlice.X!=="undefined"?d.overlay.nbSlice.X:b.overlay.nbCol*b.overlay.nbRow,Y:d.overlay.nbSlice.Y,Z:d.overlay.nbSlice.Z};b.overlay.opacity=typeof d.overlay.opacity!=="undefined"?d.overlay.opacity:1}d.colorMap=typeof d.colorMap!=="undefined"?d.colorMap:false;if(d.colorMap){b.colorMap={};b.colorMap.img=document.getElementById(d.colorMap.img);b.colorMap.min=d.colorMap.min;b.colorMap.max=d.colorMap.max;d.colorMap.hide=typeof d.colorMap.hide!=="undefined"?d.colorMap.hide:false;b.colorMap.canvas=document.createElement("canvas");b.colorMap.context=b.colorMap.canvas.getContext("2d");b.colorMap.canvas.width=b.colorMap.img.width;b.colorMap.canvas.height=b.colorMap.img.height;b.colorMap.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,b.colorMap.img.height,0,0,b.colorMap.img.width,b.colorMap.img.height)}b.getValue=function(i,h){if(!h){return NaN}var f,l,e,j,k,g;e=h.canvas.width;j=NaN;k=Infinity;for(xx=0;xx<e;xx++){f=h.context.getImageData(xx,0,1,1).data;l=Math.pow(f[0]-i[0],2)+Math.pow(f[1]-i[1],2)+Math.pow(f[2]-i[2],2);if(l<k){j=xx;k=l}}g=(j*(h.max-h.min)/(e-1))+h.min;return g};b.init=function(){b.widthCanvas.X=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.Y/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Y=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Z=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.max=Math.max(b.widthCanvas.X,b.widthCanvas.Y,b.widthCanvas.Z);b.heightCanvas.X=Math.floor(b.widthCanvas.X*b.nbSlice.Z/b.nbSlice.Y);b.heightCanvas.Y=Math.floor(b.widthCanvas.Y*b.nbSlice.Z/b.nbSlice.X);b.heightCanvas.Z=Math.floor(b.widthCanvas.Z*b.nbSlice.Y/b.nbSlice.X);b.heightCanvas.max=Math.max(b.heightCanvas.X,b.heightCanvas.Y,b.heightCanvas.Z);if(b.canvas.width!=(b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z)){b.canvas.width=b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z;b.canvas.height=Math.round((1+b.spaceFont)*(b.heightCanvas.max));b.context=a(b.context,b.smooth)}b.sizeFontPixels=Math.round(b.sizeFont*(b.heightCanvas.max));b.context.font=b.sizeFontPixels+"px Arial";b.planes.canvasMaster.width=b.sprite.width;b.planes.canvasMaster.height=b.sprite.height;b.planes.contextMaster.globalAlpha=1;b.planes.contextMaster.drawImage(b.sprite,0,0,b.sprite.width,b.sprite.height,0,0,b.sprite.width,b.sprite.height);if(b.overlay){b.planes.contextMaster.globalAlpha=b.overlay.opacity;b.planes.contextMaster.drawImage(b.overlay.sprite,0,0,b.overlay.sprite.width,b.overlay.sprite.height,0,0,b.sprite.width,b.sprite.height)}b.planes.canvasX=document.createElement("canvas");b.planes.contextX=b.planes.canvasX.getContext("2d");b.planes.canvasX.width=b.nbSlice.Y;b.planes.canvasX.height=b.nbSlice.Z;b.planes.canvasY=document.createElement("canvas");b.planes.contextY=b.planes.canvasY.getContext("2d");b.planes.canvasY.width=b.nbSlice.X;b.planes.canvasY.height=b.nbSlice.Z;b.planes.canvasZ=document.createElement("canvas");b.planes.contextZ=b.planes.canvasZ.getContext("2d");b.planes.canvasZ.width=b.nbSlice.X;b.planes.canvasZ.height=b.nbSlice.Y;b.planes.contextZ.rotate(-Math.PI/2);b.planes.contextZ.translate(-b.nbSlice.Y,0)};b.multiply=function(p,o){var l=p.length,h=p[0].length,k=o.length,f=o[0].length,g=new Array(l);for(var e=0;e<l;++e){g[e]=new Array(f);for(var n=0;n<f;++n){g[e][n]=0;for(var j=0;j<h;++j){g[e][n]+=p[e][j]*o[j][n]}}}return g};b.draw=function(i,f){var k={},j,e,h={X:"",Y:"",Z:""};h.X=Math.ceil((1-b.sizeCrosshair)*b.nbSlice.X/2);h.Y=Math.ceil((1-b.sizeCrosshair)*b.nbSlice.Y/2);h.Z=Math.ceil((1-b.sizeCrosshair)*b.nbSlice.Z/2);b.numSlice[f]=i;coordVoxel=b.multiply(b.affine,[[b.numSlice.X],[b.numSlice.Y],[b.nbSlice.Z-b.numSlice.Z],[1]]);b.coordinatesSlice.X=coordVoxel[0];b.coordinatesSlice.Y=coordVoxel[1];b.coordinatesSlice.Z=coordVoxel[2];if(b.overlay&&!b.nanValue){try{k.XW=((b.numSlice.X)%b.nbCol);k.XH=(b.numSlice.X-k.XW)/b.nbCol;b.contextRead.drawImage(b.overlay.sprite,k.XW*b.nbSlice.Y+b.numSlice.Y,k.XH*b.nbSlice.Z+b.numSlice.Z,1,1,0,0,1,1);rgb=b.contextRead.getImageData(0,0,1,1).data;b.voxelValue=b.getValue(rgb,b.colorMap)}catch(g){console.warn(g.message);rgb=0;b.nanValue=true;b.voxelValue=NaN}}else{b.voxelValue=NaN}switch(f){case"X":k.XW=((b.numSlice.X)%b.nbCol);k.XH=(b.numSlice.X-k.XW)/b.nbCol;b.planes.contextX.drawImage(b.planes.canvasMaster,k.XW*b.nbSlice.Y,k.XH*b.nbSlice.Z,b.nbSlice.Y,b.nbSlice.Z,0,0,b.nbSlice.Y,b.nbSlice.Z);if(b.crosshair){b.planes.contextX.fillStyle=b.colorCrosshair;b.planes.contextX.fillRect(b.numSlice.Y,h.Z,1,b.nbSlice.Z-2*h.Z);b.planes.contextX.fillRect(h.Y,b.numSlice.Z,b.nbSlice.Y-2*h.Y,1)}b.context.fillStyle=b.colorBackground;b.context.fillRect(0,0,b.widthCanvas.X,b.canvas.height);b.context.drawImage(b.planes.canvasX,0,0,b.nbSlice.Y,b.nbSlice.Z,0,(b.heightCanvas.max-b.heightCanvas.X)/2,b.widthCanvas.X,b.heightCanvas.X);if(b.title){b.context.fillStyle=b.colorFont;b.context.fillText(b.title,Math.round(b.widthCanvas.X/10),Math.round((b.heightCanvas.max*b.heightColorBar)+(1/4)*(b.sizeFontPixels)))}if(b.flagValue){value="value="+Number.parseFloat(b.voxelValue).toPrecision(b.nbDecimals).replace(/0+$/,"");valueWidth=b.context.measureText(value).width;b.context.fillStyle=b.colorFont;b.context.fillText(value,Math.round(b.widthCanvas.X/10),Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(b.sizeFontPixels)))}if(b.flagCoordinates){j="x="+b.coordinatesSlice.X;e=b.context.measureText(j).width;b.context.fillStyle=b.colorFont;b.context.fillText(j,b.widthCanvas.X/2-e/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}break;case"Y":b.context.fillStyle=b.colorBackground;b.context.fillRect(b.widthCanvas.X,0,b.widthCanvas.Y,b.canvas.height);for(xx=0;xx<b.nbSlice.X;xx++){posW=(xx%b.nbCol);posH=(xx-posW)/b.nbCol;b.planes.contextY.drawImage(b.planes.canvasMaster,posW*b.nbSlice.Y+b.numSlice.Y,posH*b.nbSlice.Z,1,b.nbSlice.Z,xx,0,1,b.nbSlice.Z)}if(b.crosshair){b.planes.contextY.fillStyle=b.colorCrosshair;b.planes.contextY.fillRect(b.numSlice.X,h.Z,1,b.nbSlice.Z-2*h.Z);b.planes.contextY.fillRect(h.X,b.numSlice.Z,b.nbSlice.X-2*h.X,1)}b.context.drawImage(b.planes.canvasY,0,0,b.nbSlice.X,b.nbSlice.Z,b.widthCanvas.X,(b.heightCanvas.max-b.heightCanvas.Y)/2,b.widthCanvas.Y,b.heightCanvas.Y);if((b.colorMap)&&(!b.colorMap.hide)){b.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,1,Math.round(b.widthCanvas.X+b.widthCanvas.Y*0.2),Math.round(b.heightCanvas.max*b.heightColorBar/2),Math.round(b.widthCanvas.Y*0.6),Math.round(b.heightCanvas.max*b.heightColorBar));b.context.fillStyle=b.colorFont;label_min=Number.parseFloat(b.colorMap.min).toPrecision(b.nbDecimals).replace(/0+$/,"");label_max=Number.parseFloat(b.colorMap.max).toPrecision(b.nbDecimals).replace(/0+$/,"");b.context.fillText(label_min,b.widthCanvas.X+(b.widthCanvas.Y*0.2),Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(b.sizeFontPixels)));b.context.fillText(label_max,b.widthCanvas.X+(b.widthCanvas.Y*0.8)-b.context.measureText(label_max).width,Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(b.sizeFontPixels)))}if(b.flagCoordinates){b.context.font=b.sizeFontPixels+"px Arial";b.context.fillStyle=b.colorFont;j="y="+b.coordinatesSlice.Y;e=b.context.measureText(j).width;b.context.fillText(j,b.widthCanvas.X+(b.widthCanvas.Y/2)-e/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}case"Z":b.context.fillStyle=b.colorBackground;b.context.fillRect(b.widthCanvas.X+b.widthCanvas.Y,0,b.widthCanvas.Z,b.canvas.height);for(xx=0;xx<b.nbSlice.X;xx++){posW=(xx%b.nbCol);posH=(xx-posW)/b.nbCol;b.planes.contextZ.drawImage(b.planes.canvasMaster,posW*b.nbSlice.Y,posH*b.nbSlice.Z+b.numSlice.Z,b.nbSlice.Y,1,0,xx,b.nbSlice.Y,1)}if(b.crosshair){b.planes.contextZ.fillStyle=b.colorCrosshair;b.planes.contextZ.fillRect(h.Y,b.numSlice.X,b.nbSlice.Y-2*h.Y,1);b.planes.contextZ.fillRect(b.numSlice.Y,h.X,1,b.nbSlice.X-2*h.X)}b.context.drawImage(b.planes.canvasZ,0,0,b.nbSlice.X,b.nbSlice.Y,b.widthCanvas.X+b.widthCanvas.Y,(b.heightCanvas.max-b.heightCanvas.Z)/2,b.widthCanvas.Z,b.heightCanvas.Z);if(b.flagCoordinates){j="z="+b.coordinatesSlice.Z;e=b.context.measureText(j).width;b.context.fillStyle=b.colorFont;b.context.fillText(j,b.widthCanvas.X+b.widthCanvas.Y+(b.widthCanvas.Z/2)-e/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}}};b.clickBrain=function(h){var f=b.canvas.getBoundingClientRect();var j=h.clientX-f.left;var k=h.clientY-f.top;var i,g;if(j<b.widthCanvas.X){i=Math.round(b.nbSlice.Y*(j/b.widthCanvas.X));g=Math.round(b.nbSlice.Z*(k-((b.heightCanvas.max-b.heightCanvas.X)/2))/b.heightCanvas.X);b.numSlice.Y=Math.max(Math.min(i,b.nbSlice.Y-1),0);b.numSlice.Z=Math.max(Math.min(g,b.nbSlice.Z-1),0)}else{if(j<(b.widthCanvas.X+b.widthCanvas.Y)){j=j-b.widthCanvas.X;sx=Math.round(b.nbSlice.X*(j/b.widthCanvas.Y));g=Math.round(b.nbSlice.Z*(k-((b.heightCanvas.max-b.heightCanvas.X)/2))/b.heightCanvas.X);b.numSlice.X=Math.max(Math.min(sx,b.nbSlice.X-1),0);b.numSlice.Z=Math.max(Math.min(g,b.nbSlice.Z-1),0)}else{j=j-b.widthCanvas.X-b.widthCanvas.Y;sx=Math.round(b.nbSlice.X*(j/b.widthCanvas.Z));i=Math.round(b.nbSlice.Y*(1-((k-((b.heightCanvas.max-b.heightCanvas.Z)/2))/b.heightCanvas.Z)));b.numSlice.X=Math.max(Math.min(sx,b.nbSlice.X-1),0);b.numSlice.Y=Math.max(Math.min(i,b.nbSlice.Y-1),0)}}b.drawAll();if(b.onclick){b.onclick(h)}};b.drawAll=function(){b.draw(b.numSlice.X,"X");b.draw(b.numSlice.Y,"Y");b.draw(b.numSlice.Z,"Z")};b.canvas.addEventListener("click",b.clickBrain,false);b.canvas.addEventListener("mousedown",function(f){b.canvas.addEventListener("mousemove",b.clickBrain,false)},false);b.canvas.addEventListener("mouseup",function(f){b.canvas.removeEventListener("mousemove",b.clickBrain,false)},false);b.sprite.addEventListener("load",function(){b.init();b.drawAll()});if(b.overlay){b.overlay.sprite.addEventListener("load",function(){b.init();b.drawAll()})}b.init();b.drawAll();return b};